<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firestore ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ãƒ„ãƒ¼ãƒ«ï¼ˆREST APIç‰ˆï¼‰</title>
<style>
  :root { --bg:#f8f9fa; --card:#fff; --blue:#4285f4; --green:#34a853; --red:#ea4335; --yellow:#fbbc04; }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:#333;padding:20px;max-width:760px;margin:0 auto}
  h1{font-size:22px;margin-bottom:4px} .sub{color:#888;font-size:13px;margin-bottom:20px}
  .card{background:var(--card);border-radius:12px;padding:16px 20px;margin-bottom:14px;box-shadow:0 1px 6px rgba(0,0,0,0.06);border-left:4px solid #ddd}
  .card.active{border-left-color:var(--blue)} .card.done{border-left-color:var(--green)} .card.err{border-left-color:var(--red)}
  .num{display:inline-flex;width:26px;height:26px;border-radius:50%;background:#e0e0e0;color:#888;align-items:center;justify-content:center;font-size:12px;font-weight:900;margin-right:8px}
  .card.active .num{background:var(--blue);color:#fff} .card.done .num{background:var(--green);color:#fff}
  .title{font-weight:700;font-size:15px}
  .body{margin-top:10px;font-size:14px;line-height:1.8}
  input[type=text]{width:100%;padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;font-family:monospace;margin-top:4px}
  input:focus{border-color:var(--blue);outline:none}
  .row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
  .row label{width:100px;font-size:13px;font-weight:700;flex-shrink:0}
  button{padding:8px 20px;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;margin-top:8px}
  .btn-blue{background:var(--blue);color:#fff} .btn-blue:hover{background:#3367d6}
  .btn-green{background:var(--green);color:#fff} .btn-yellow{background:var(--yellow);color:#333}
  .btn-blue:disabled,.btn-green:disabled{background:#ccc;cursor:not-allowed}
  .badge{display:inline-block;padding:2px 10px;border-radius:10px;font-size:11px;font-weight:700;margin-left:8px}
  .badge-ok{background:#e6f4ea;color:var(--green)} .badge-err{background:#fce8e6;color:var(--red)} .badge-wait{background:#f1f1f1;color:#888} .badge-run{background:#e8f0fe;color:var(--blue)}
  .log{margin-top:12px;background:#f5f5f5;border-radius:8px;padding:12px;font-size:12px;font-family:monospace;max-height:350px;overflow-y:auto;white-space:pre-wrap;line-height:1.8}
  .log .ok{color:var(--green)} .log .er{color:var(--red)} .log .wr{color:#f57c00} .log .bl{color:var(--blue)}
  pre.rules{background:#263238;color:#eee;padding:12px;border-radius:8px;font-size:10px;overflow:auto;max-height:180px;line-height:1.5;margin-top:8px}
  a{color:var(--blue)}
  details{margin-top:8px} details summary{cursor:pointer;color:var(--blue);font-size:13px}
  .hidden{display:none}
</style>
</head>
<body>
<h1>ğŸ”§ Firestore ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ãƒ„ãƒ¼ãƒ«</h1>
<p class="sub">REST APIç‰ˆ â€” Firebase SDK ä¸è¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã§å‹•ãã¾ã™</p>

<!-- Step 1 -->
<div class="card active" id="s1">
  <span class="num">1</span><span class="title">Firebase è¨­å®šã‚’å…¥åŠ›</span>
  <div class="body" id="s1b">
    <p style="font-size:13px;color:#666;margin-bottom:8px">
      <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a> ã§ä»¥ä¸‹ã‚’æº–å‚™ã—ã¦ãã ã•ã„ï¼š
    </p>
    <details open>
      <summary>æº–å‚™æ‰‹é †ï¼ˆåˆã‚ã¦ã®å ´åˆï¼‰</summary>
      <ol style="font-size:13px;padding-left:20px;line-height:2;margin-top:4px">
        <li>Firebase Console ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ</li>
        <li>å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒFirestore Databaseã€â†’ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã€â†’ <b>ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</b> ã§é–‹å§‹</li>
        <li>å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒAuthenticationã€â†’ã€Œå§‹ã‚ã‚‹ã€â†’ã€ŒGoogleã€ã‚’æœ‰åŠ¹åŒ–</li>
        <li>âš™ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š â†’ å…¨èˆ¬ â†’ ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã‚’è¿½åŠ </li>
        <li>è¡¨ç¤ºã•ã‚Œã‚‹ firebaseConfig ã®å€¤ã‚’ä¸‹ã«å…¥åŠ›</li>
      </ol>
    </details>
    <div class="row"><label>apiKey</label><input type="text" id="apiKey" placeholder="AIzaSy..."></div>
    <div class="row"><label>authDomain</label><input type="text" id="authDomain" placeholder="your-app.firebaseapp.com"></div>
    <div class="row"><label>projectId</label><input type="text" id="projectId" placeholder="your-app-id"></div>
    <button class="btn-blue" onclick="doStep1()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
    <span class="badge badge-wait" id="s1badge">æœªæ¥ç¶š</span>
  </div>
</div>

<!-- Step 2 -->
<div class="card" id="s2">
  <span class="num">2</span><span class="title">Google ãƒ­ã‚°ã‚¤ãƒ³</span>
  <div class="body hidden" id="s2b">
    <p style="font-size:13px;color:#666;margin-bottom:8px">æ•™å¸«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚ã“ã®UIDãŒ teacherUids ã«è¨­å®šã•ã‚Œã¾ã™ã€‚</p>
    <button class="btn-blue" id="loginBtn" onclick="doStep2()">ğŸ”‘ Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <span class="badge badge-wait" id="s2badge">æœªãƒ­ã‚°ã‚¤ãƒ³</span>
    <div id="userInfo" style="margin-top:8px;font-size:13px" class="hidden"></div>
  </div>
</div>

<!-- Step 3 -->
<div class="card" id="s3">
  <span class="num">3</span><span class="title">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«</span>
  <div class="body hidden" id="s3b">
    <p style="font-size:13px;color:#666">ãƒ‡ãƒ¼ã‚¿æŠ•å…¥å¾Œã« Firebase Console â†’ Firestore â†’ ãƒ«ãƒ¼ãƒ« ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
    <p style="font-size:12px;color:#f57c00">âš  ä»Šã¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ã¾ã¾æ¬¡ã«é€²ã‚“ã§OK</p>
    <button class="btn-yellow" onclick="copyRules()">ğŸ“‹ ãƒ«ãƒ¼ãƒ«ã‚’ã‚³ãƒ”ãƒ¼</button>
    <button class="btn-blue" onclick="doStep3()" style="margin-left:8px">æ¬¡ã¸ â†’</button>
    <span id="rulesCopied" style="font-size:12px;color:var(--green)" class="hidden"> âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</span>
    <pre class="rules" id="rulesText"></pre>
  </div>
</div>

<!-- Step 4 -->
<div class="card" id="s4">
  <span class="num">4</span><span class="title">ãƒ‡ãƒ¼ã‚¿æŠ•å…¥</span>
  <div class="body hidden" id="s4b">
    <p style="font-size:13px;color:#666;margin-bottom:8px">config/app + 10ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ Firestore REST API ã§æ›¸ãè¾¼ã¿ã¾ã™ã€‚</p>
    <button class="btn-green" id="seedBtn" onclick="doStep4()">ğŸš€ ãƒ‡ãƒ¼ã‚¿æŠ•å…¥é–‹å§‹</button>
    <span class="badge badge-wait" id="s4badge">æœªå®Ÿè¡Œ</span>
    <div class="log hidden" id="seedLog"></div>
  </div>
</div>

<!-- Step 5 -->
<div class="card" id="s5">
  <span class="num">5</span><span class="title">ç¢ºèª</span>
  <div class="body hidden" id="s5b">
    <button class="btn-blue" id="verifyBtn" onclick="doStep5()">âœ… ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
    <span class="badge badge-wait" id="s5badge">æœªç¢ºèª</span>
    <div class="log hidden" id="verifyLog"></div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€
let CFG = {};
let TOKEN = '';
let USER = null;

const RULES = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuth() { return request.auth != null; }
    function isTeacher() {
      return isAuth() && request.auth.uid in
        get(/databases/$(database)/documents/config/app).data.teacherUids;
    }
    function isOwner(uid) { return isAuth() && request.auth.uid == uid; }

    match /config/app { allow read: if isAuth(); allow write: if isTeacher(); }
    match /templates/{t} { allow read: if isAuth(); }
    match /users/{uid} {
      allow read, write: if isOwner(uid);
      match /rounds/{r} {
        allow read, write: if isOwner(uid);
        match /items/{i} { allow read, write: if isOwner(uid); }
      }
    }
    match /helpRequests/{r} {
      allow create: if isAuth() && request.resource.data.studentUid == request.auth.uid;
      allow read, update: if isTeacher();
    }
  }
}`;

// â”€â”€ Firestore REST helpers â”€â”€
function fsBase() {
  return `https://firestore.googleapis.com/v1/projects/${CFG.projectId}/databases/(default)/documents`;
}

function toFirestoreValue(val) {
  if (val === null || val === undefined) return { nullValue: null };
  if (typeof val === 'boolean') return { booleanValue: val };
  if (typeof val === 'number') {
    if (Number.isInteger(val)) return { integerValue: String(val) };
    return { doubleValue: val };
  }
  if (typeof val === 'string') return { stringValue: val };
  if (Array.isArray(val)) return { arrayValue: { values: val.map(toFirestoreValue) } };
  if (typeof val === 'object') {
    const fields = {};
    for (const [k, v] of Object.entries(val)) {
      fields[k] = toFirestoreValue(v);
    }
    return { mapValue: { fields } };
  }
  return { stringValue: String(val) };
}

function toFirestoreDoc(obj) {
  const fields = {};
  for (const [k, v] of Object.entries(obj)) {
    fields[k] = toFirestoreValue(v);
  }
  return { fields };
}

function fromFirestoreValue(v) {
  if ('stringValue' in v) return v.stringValue;
  if ('integerValue' in v) return parseInt(v.integerValue);
  if ('doubleValue' in v) return v.doubleValue;
  if ('booleanValue' in v) return v.booleanValue;
  if ('nullValue' in v) return null;
  if ('arrayValue' in v) return (v.arrayValue.values || []).map(fromFirestoreValue);
  if ('mapValue' in v) {
    const obj = {};
    for (const [k, fv] of Object.entries(v.mapValue.fields || {})) obj[k] = fromFirestoreValue(fv);
    return obj;
  }
  return null;
}

async function fsSet(path, data) {
  const url = `${fsBase()}/${path}`;
  const resp = await fetch(url, {
    method: 'PATCH',
    headers: { 'Authorization': `Bearer ${TOKEN}`, 'Content-Type': 'application/json' },
    body: JSON.stringify(toFirestoreDoc(data)),
  });
  if (!resp.ok) {
    const err = await resp.text();
    throw new Error(`PATCH ${path}: ${resp.status} ${err}`);
  }
  return resp.json();
}

async function fsGet(path) {
  const url = `${fsBase()}/${path}`;
  const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${TOKEN}` } });
  if (!resp.ok) throw new Error(`GET ${path}: ${resp.status}`);
  return resp.json();
}

async function fsList(collectionPath) {
  const url = `${fsBase()}/${collectionPath}`;
  const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${TOKEN}` } });
  if (!resp.ok) throw new Error(`LIST ${collectionPath}: ${resp.status}`);
  return resp.json();
}

// â”€â”€ Google OAuth (popup) â”€â”€
function googleLogin() {
  return new Promise((resolve, reject) => {
    const clientId = CFG.apiKey; // We need the OAuth client ID, not apiKey
    // Use Google Identity Services via a popup approach with the Firebase Auth REST API
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
      `client_id=${encodeURIComponent(CFG.clientId || '')}&` +
      `redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}&` +
      `response_type=token&` +
      `scope=openid email profile&` +
      `prompt=select_account`;

    // Instead, let's use Firebase Auth REST API with signInWithIdp
    // Actually, the simplest approach for Chromebook: use Firebase Auth REST API
    // Step 1: Get Google OAuth token via popup
    // Step 2: Exchange it for Firebase ID token

    // For simplicity, we'll use a popup window approach
    const width = 500, height = 600;
    const left = (screen.width - width) / 2, top = (screen.height - height) / 2;
    const popup = window.open(authUrl, 'googleLogin', `width=${width},height=${height},left=${left},top=${top}`);

    const timer = setInterval(() => {
      try {
        if (popup.closed) { clearInterval(timer); reject(new Error('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ')); return; }
        const url = popup.location.href;
        if (url.includes('access_token=')) {
          clearInterval(timer);
          const hash = popup.location.hash.substring(1);
          const params = new URLSearchParams(hash);
          popup.close();
          resolve(params.get('access_token'));
        }
      } catch (e) { /* cross-origin, keep waiting */ }
    }, 200);
  });
}

async function firebaseSignIn(googleAccessToken) {
  // Exchange Google access token for Firebase ID token
  const resp = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:signInWithIdp?key=${CFG.apiKey}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      postBody: `access_token=${googleAccessToken}&providerId=google.com`,
      requestUri: window.location.href,
      returnSecureToken: true,
      returnIdpCredential: true,
    }),
  });
  if (!resp.ok) {
    const err = await resp.json();
    throw new Error(err.error?.message || 'Firebaseèªè¨¼ã‚¨ãƒ©ãƒ¼');
  }
  return resp.json();
}

// â”€â”€ UI helpers â”€â”€
function show(id) { document.getElementById(id).classList.remove('hidden'); }
function hide(id) { document.getElementById(id).classList.add('hidden'); }
function setCard(id, cls) {
  const el = document.getElementById(id);
  el.classList.remove('active','done','err');
  if (cls) el.classList.add(cls);
}
function setBadge(id, cls, text) {
  const el = document.getElementById(id);
  el.className = 'badge ' + cls;
  el.textContent = text;
}
function log(targetId, msg, cls='') {
  const el = document.getElementById(targetId);
  el.classList.remove('hidden');
  el.innerHTML += `<span class="${cls}">${msg}</span>\n`;
  el.scrollTop = el.scrollHeight;
}

// â”€â”€ Step 1 â”€â”€
async function doStep1() {
  const apiKey = document.getElementById('apiKey').value.trim();
  const authDomain = document.getElementById('authDomain').value.trim();
  const projectId = document.getElementById('projectId').value.trim();

  if (!apiKey || !authDomain || !projectId) { alert('3ã¤ã®é …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  CFG = { apiKey, authDomain, projectId };

  // Extract OAuth client ID from authDomain (format: project-id.firebaseapp.com)
  // We'll need the Web Client ID. For Firebase projects, we can look it up.
  // Actually, we need to get the OAuth client ID from the Firebase project.
  // Let's try to fetch it from the Firebase Auth config
  setBadge('s1badge', 'badge-run', 'ç¢ºèªä¸­...');

  try {
    // Test Firestore connectivity (will fail with auth error, but that's ok - confirms project exists)
    const resp = await fetch(`https://firestore.googleapis.com/v1/projects/${projectId}/databases/(default)/documents/config/app`);
    // 404 = doc not found (project exists, firestore works)
    // 403 = auth required (project exists, firestore works)
    // Other = project might not exist
    if (resp.status === 404 || resp.status === 200 || resp.status === 403) {
      setBadge('s1badge', 'badge-ok', `æ¥ç¶šOK (${projectId})`);
      setCard('s1', 'done');
      setCard('s2', 'active');
      show('s2b');
    } else {
      throw new Error(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ "${projectId}" ã«æ¥ç¶šã§ãã¾ã›ã‚“ (${resp.status})`);
    }
  } catch (e) {
    if (e.message.includes('Failed to fetch')) {
      // Network issue, but might still work - let's proceed
      setBadge('s1badge', 'badge-ok', `è¨­å®šä¿å­˜ (${projectId})`);
      setCard('s1', 'done');
      setCard('s2', 'active');
      show('s2b');
    } else {
      setBadge('s1badge', 'badge-err', 'ã‚¨ãƒ©ãƒ¼');
      alert(e.message);
    }
  }
}

// â”€â”€ Step 2: Login via Firebase Auth REST API â”€â”€
async function doStep2() {
  setBadge('s2badge', 'badge-run', 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');

  try {
    // Method: Open Google sign-in page, get the auth code, exchange for Firebase token
    // We use the Firebase Auth signInWithPopup equivalent via REST

    // First, we need to get the Google OAuth client ID for this Firebase project
    // The simplest way: get it from the authDomain's __/auth/handler page
    // OR we can use the Firebase Auth REST API's createAuthUri to get the auth URL

    // Approach: Use Firebase Auth REST API signInWithIdp
    // But we need a Google OAuth token first.
    // Let's use the Google Sign-In for Web (legacy) approach with a popup

    // Get OAuth config from Firebase
    const configResp = await fetch(`https://www.googleapis.com/identitytoolkit/v3/relyingparty/getProjectConfig?key=${CFG.apiKey}`);
    const configData = await configResp.json();

    let clientId = '';
    if (configData.authorizedDomains && configData.idpConfig) {
      for (const idp of configData.idpConfig) {
        if (idp.provider === 'google.com' && idp.clientId) {
          clientId = idp.clientId;
          break;
        }
      }
    }

    if (!clientId) {
      // Try alternate API
      const resp2 = await fetch(`https://identitytoolkit.googleapis.com/v2/projects/${CFG.projectId}/defaultSupportedIdpConfigs/google.com?key=${CFG.apiKey}`);
      if (resp2.ok) {
        const d = await resp2.json();
        clientId = d.clientId;
      }
    }

    if (!clientId) {
      throw new Error('Google OAuth Client ID ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nFirebase Console â†’ Authentication â†’ Google ãŒæœ‰åŠ¹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }

    CFG.clientId = clientId;

    // Open Google OAuth popup
    const redirectUri = window.location.origin + window.location.pathname;
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
      `client_id=${encodeURIComponent(clientId)}&` +
      `redirect_uri=${encodeURIComponent(redirectUri)}&` +
      `response_type=token&` +
      `scope=${encodeURIComponent('openid email profile')}&` +
      `prompt=select_account`;

    const googleToken = await new Promise((resolve, reject) => {
      const w = 500, h = 600;
      const l = (screen.width - w) / 2, t = (screen.height - h) / 2;
      const popup = window.open(authUrl, 'googleAuth', `width=${w},height=${h},left=${l},top=${t}`);

      if (!popup) { reject(new Error('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚')); return; }

      const check = setInterval(() => {
        try {
          if (popup.closed) { clearInterval(check); reject(new Error('ãƒ­ã‚°ã‚¤ãƒ³ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ')); return; }
          const u = popup.location.href;
          if (u && u.includes('access_token=')) {
            clearInterval(check);
            const hash = popup.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            popup.close();
            resolve(params.get('access_token'));
          }
        } catch(e) { /* cross-origin, keep polling */ }
      }, 300);

      // Timeout after 2 minutes
      setTimeout(() => { clearInterval(check); try{popup.close();}catch(e){} reject(new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')); }, 120000);
    });

    // Exchange Google token for Firebase ID token
    const fbAuth = await firebaseSignIn(googleToken);
    TOKEN = fbAuth.idToken;
    USER = {
      uid: fbAuth.localId,
      displayName: fbAuth.displayName || fbAuth.email,
      email: fbAuth.email,
    };

    document.getElementById('userInfo').innerHTML =
      `ğŸ‘¤ <b>${USER.displayName}</b> (${USER.email})<br><code style="font-size:11px">UID: ${USER.uid}</code>`;
    show('userInfo');

    setBadge('s2badge', 'badge-ok', USER.displayName);
    setCard('s2', 'done');
    setCard('s3', 'active');
    show('s3b');
    document.getElementById('rulesText').textContent = RULES;

  } catch (e) {
    setBadge('s2badge', 'badge-err', 'ã‚¨ãƒ©ãƒ¼');
    alert('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

// â”€â”€ Step 3 â”€â”€
function copyRules() {
  navigator.clipboard.writeText(RULES).then(() => {
    show('rulesCopied');
    setTimeout(() => hide('rulesCopied'), 3000);
  }).catch(() => {
    // Fallback: select the text
    const el = document.getElementById('rulesText');
    const range = document.createRange();
    range.selectNodeContents(el);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¾ã—ãŸã€‚Ctrl+C ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
  });
}

function doStep3() {
  setCard('s3', 'done');
  setCard('s4', 'active');
  show('s4b');
}

// â”€â”€ Step 4: Seed data â”€â”€
async function doStep4() {
  const logId = 'seedLog';
  setBadge('s4badge', 'badge-run', 'æŠ•å…¥ä¸­...');
  document.getElementById('seedBtn').disabled = true;

  try {
    // config/app
    log(logId, 'ğŸ“ config/app ã‚’ä½œæˆä¸­...', 'bl');
    await fsSet('config/app', {
      teacherUids: [USER.uid],
      defaultQuestionCount: 10,
      slackWebhookConfigured: false,
    });
    log(logId, `  âœ… teacherUids: ["${USER.uid}"]`, 'ok');

    // Templates
    const templates = getTemplates();
    for (const tmpl of templates) {
      log(logId, `ğŸ“ templates/${tmpl.templateId} ...`, 'bl');
      await fsSet(`templates/${tmpl.templateId}`, tmpl);
      log(logId, `  âœ… ${tmpl.meta.displayName}`, 'ok');
    }

    log(logId, `\nğŸ‰ å®Œäº†ï¼ config/app + ${templates.length} ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æŠ•å…¥ã—ã¾ã—ãŸ`, 'ok');
    setBadge('s4badge', 'badge-ok', `${templates.length}ãƒ†ãƒ³ãƒ—ãƒ¬æŠ•å…¥å®Œäº†`);
    setCard('s4', 'done');
    setCard('s5', 'active');
    show('s5b');

  } catch (e) {
    log(logId, `\nâŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'er');
    log(logId, 'ğŸ’¡ Firestore ãŒã€Œãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã€ã§ä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'wr');
    setBadge('s4badge', 'badge-err', 'ã‚¨ãƒ©ãƒ¼');
    document.getElementById('seedBtn').disabled = false;
  }
}

// â”€â”€ Step 5: Verify â”€â”€
async function doStep5() {
  const logId = 'verifyLog';
  setBadge('s5badge', 'badge-run', 'ç¢ºèªä¸­...');

  try {
    // config/app
    const configDoc = await fsGet('config/app');
    if (configDoc.fields) {
      const uids = configDoc.fields.teacherUids?.arrayValue?.values?.map(v => v.stringValue) || [];
      log(logId, `âœ… config/app: teacherUids=${JSON.stringify(uids)}`, 'ok');
    } else {
      log(logId, 'âŒ config/app ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'er');
    }

    // templates
    const listResp = await fsList('templates');
    const docs = listResp.documents || [];
    log(logId, `\nğŸ“¦ templates: ${docs.length} ä»¶`, 'bl');
    for (const doc of docs) {
      const id = doc.name.split('/').pop();
      const name = doc.fields?.meta?.mapValue?.fields?.displayName?.stringValue || '';
      const type = doc.fields?.type?.stringValue || '';
      log(logId, `  âœ… ${id} â€” ${name} [${type}]`, 'ok');
    }

    if (docs.length === 10) {
      log(logId, '\nğŸ‰ å…¨10ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç¢ºèªOKï¼ Firebase Console ã§ã‚‚ã”ç¢ºèªãã ã•ã„ã€‚', 'ok');
      setBadge('s5badge', 'badge-ok', 'å…¨10ãƒ†ãƒ³ãƒ—ãƒ¬OK');
      setCard('s5', 'done');
    } else {
      log(logId, `\nâš  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ•°: ${docs.length}/10`, 'wr');
      setBadge('s5badge', 'badge-err', `${docs.length}/10`);
    }
  } catch (e) {
    log(logId, `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'er');
    setBadge('s5badge', 'badge-err', 'ã‚¨ãƒ©ãƒ¼');
  }
}

// â”€â”€ Template data â”€â”€
function getTemplates() {
  return [
    {templateId:'coin_optimal_payment',generatorId:'pool',type:'numeric',grade:2,unit:'ãŠé‡‘',tags:['ç¡¬è²¨','ãŠã¤ã‚Š','æœ€é©åŒ–'],meta:{displayName:'ãŠã¤ã‚Šæœ€å°åŒ–',description:'æ‰‹æŒã¡ç¡¬è²¨ã§ãŠã¤ã‚Šæšæ•°ãŒæœ€å°ã«ãªã‚‹æ”¯æ‰•ã„é¡ã‚’æ±‚ã‚ã‚‹'},pool:[{poolIndex:0,prompt:'152å††ï¼ˆ100å††ç‰ 1ã¾ã„ã€50å††ç‰ 1ã¾ã„ã€1å††ç‰ 2ã¾ã„ï¼‰ã‚’ ã‚‚ã£ã¦ã„ã¾ã™ã€‚\n82å††ã® ã‘ã—ã‚´ãƒ ã‚’ è²·ã„ã¾ã™ã€‚\nãŠã¤ã‚Šã® ã“ã†ã‹ã® ã¾ã„æ•°ã‚’ ã„ã¡ã°ã‚“ å°‘ãªã ã™ã‚‹ã«ã¯ã€ã„ãã‚‰ ã¯ã‚‰ãˆã° ã‚ˆã„ã§ã™ã‹ã€‚',images:null,correctAnswer:'102',explanation:'102å††ã¯ã‚‰ã†ã¨ã€ãŠã¤ã‚Šã¯ 102âˆ’82ï¼20å††ï¼ˆ10å††ç‰2ã¾ã„ï¼‰ã§ã™ã€‚'},{poolIndex:1,prompt:'100å††ç‰ 1ã¾ã„ã€10å††ç‰ 3ã¾ã„ã€1å††ç‰ 4ã¾ã„ ã‚’æŒã£ã¦ã„ã¾ã™ã€‚\nãƒã‚¹ä»£ã¯ 73å††ã§ã™ã€‚\nãŠã¤ã‚Šã® ã¾ã„æ•°ãŒ ã„ã¡ã°ã‚“ å°‘ãªããªã‚‹ã‚ˆã†ã« æ‰•ã†ã¨ãã€ã„ãã‚‰ æ‰•ãˆã° ã‚ˆã„ã§ã™ã‹ã€‚',images:null,correctAnswer:'103',explanation:'103å††ã¯ã‚‰ã†ã¨ã€ãŠã¤ã‚Šã¯ 103âˆ’73ï¼30å††ï¼ˆ10å††ç‰3ã¾ã„ï¼‰ã§ã™ã€‚'}]},
    {templateId:'expr_scene_matching',generatorId:'pool',type:'mcq',grade:2,unit:'ãŸã—ç®—ã¨ã²ãç®—ãƒ»ã‹ã‘ç®—',tags:['å¼ã¨å ´é¢'],meta:{displayName:'å¼ã¨å ´é¢ã®ãƒãƒƒãƒãƒ³ã‚°',description:'å¼ã«åˆã†å ´é¢ã‚’é¸ã¶'},pool:[{poolIndex:0,subId:'2-1',prompt:'6Ã—4 ã® ã‚‚ã‚“ã ã„ã¯ã€ã©ã‚Œã§ã™ã‹ã€‚',images:null,choices:[{label:'ãˆã‚“ã´ã¤ãŒ 6æœ¬ ã‚ã‚Šã¾ã™ã€‚4æœ¬ ã‚‚ã‚‰ã£ãŸã®ã§ã€ãœã‚“ã¶ã§ ä½•æœ¬ã« ãªã‚Šã¾ã—ãŸã‹ã€‚',semantic:{kind:'add',subtype:'increase'}},{label:'ãˆã‚“ã´ã¤ãŒ 6æœ¬ãšã¤ å…¥ã£ãŸ ã¯ã“ãŒ 4ã¯ã“ ã‚ã‚Šã¾ã™ã€‚ãˆã‚“ã´ã¤ã¯ ãœã‚“ã¶ã§ ä½•æœ¬ ã‚ã‚Šã¾ã™ã‹ã€‚',semantic:{kind:'mul',subtype:'per_x_groups'}},{label:'ãˆã‚“ã´ã¤ã‚’ 4æœ¬ ã¤ã‹ã£ãŸã‚‰ã€6æœ¬ã« ãªã‚Šã¾ã—ãŸã€‚ã¯ã˜ã‚ã« ä½•æœ¬ ã‚ã‚Šã¾ã—ãŸã‹ã€‚',semantic:{kind:'add',subtype:'count_back'}},{label:'ãˆã‚“ã´ã¤ãŒ 6æœ¬ ã‚ã‚Šã¾ã™ã€‚4æœ¬ ã‚ã’ã‚‹ã¨ã€ã®ã“ã‚Šã¯ ä½•æœ¬ã§ã™ã‹ã€‚',semantic:{kind:'sub',subtype:'take_away'}}],correctAnswer:1,explanation:'ã€Œ6æœ¬ãšã¤ã€Ã—ã€Œ4ã¯ã“ã€= 6Ã—4'},{poolIndex:1,subId:'2-2',prompt:'â–¡ï¼‹47ï¼83 ã«åˆã†å ´é¢ã¯ã©ã‚Œã§ã™ã‹ã€‚',images:null,choices:[{label:'47äºº å¸°ã£ãŸã‚‰ 83äººã« ãªã£ãŸ',semantic:null},{label:'83äººã®ã†ã¡ 47äºº å¸°ã£ãŸ',semantic:{kind:'sub',subtype:'take_away'}},{label:'47äºº æ¥ã¦ 83äººã« ãªã£ãŸ',semantic:{kind:'add',subtype:'increase',unknownPosition:'operand1'}},{label:'83äººã‹ã‚‰ 47äºº ã„ãªããªã£ãŸ',semantic:{kind:'sub',subtype:'take_away'}}],correctAnswer:2,explanation:'â–¡ï¼‹47ï¼83 â†’ã€Œ47äººæ¥ã¦83äººã«ãªã£ãŸã€'}]},
    {templateId:'cut_count_triangles',generatorId:'pool',type:'numeric',grade:2,unit:'å›³å½¢',tags:['åˆ‡æ–­','ä¸‰è§’å½¢'],meta:{displayName:'ç›´ç·šåˆ‡æ–­â†’ä¸‰è§’å½¢ã®æ•°',description:'ä¸¸ã„ã‚±ãƒ¼ã‚­ã‚’åˆ‡ã£ãŸã¨ãã®ä¸‰è§’å½¢ã®æ•°'},pool:[{poolIndex:0,prompt:'ä¸¸ã„ã‚±ãƒ¼ã‚­ã‚’ 3å› ã¾ã£ã™ãã« åˆ‡ã‚Šã¾ã—ãŸã€‚\nã§ãã‚‹ä¸‰è§’å½¢ã¯ ã„ãã¤ ã‚ã‚Šã¾ã™ã‹ã€‚',images:{prompt:'svg/cut_circle_3lines_triangle.svg',choices:null},correctAnswer:'1',explanation:'3æœ¬ãŒåˆ¥ã€…ã®å ´æ‰€ã§äº¤ã‚ã‚‹ã¨ã€ã¾ã‚“ä¸­ã«ä¸‰è§’å½¢ãŒ1ã“ã€‚'}]},
    {templateId:'cut_quadrilaterals',generatorId:'pool',type:'mcq',grade:2,unit:'å›³å½¢',tags:['åˆ‡æ–­','å››è§’å½¢'],meta:{displayName:'ç›´ç·šåˆ‡æ–­â†’å››è§’å½¢',description:'å††ã‚’4å›åˆ‡ã£ã¦å››è§’å½¢ã‚’æœ€å¤§åŒ–'},pool:[{poolIndex:0,subId:'4-1',prompt:'ã¾ã‚‹ã„ ã‹ã¿ã‚’ ã¾ã£ã™ããª ç·šã§ 4å› åˆ‡ã‚Šã¾ã™ã€‚\nå››è§’å½¢ãŒ ã„ã¡ã°ã‚“ å¤šã ã§ãã‚‹ã®ã¯ ã©ã‚Œã§ã™ã‹ã€‚',images:{prompt:null,choices:['svg/cut_circle_4lines_star.svg','svg/cut_circle_4lines_parallel.svg','svg/cut_circle_4lines_grid_choice.svg']},choices:[{label:'ã‚¢'},{label:'ã‚¤'},{label:'ã‚¦'}],correctAnswer:2,explanation:'ã‚¦ï¼ˆæ ¼å­å‹ï¼‰ã§ã¾ã‚“ä¸­ã«å››è§’å½¢1ã“ã€‚'},{poolIndex:1,subId:'4-2',prompt:'ä¸¸ã„ãƒ”ã‚¶ã‚’ 4å› ã¾ã£ã™ãã« åˆ‡ã‚Šã¾ã—ãŸã€‚\nå››è§’å½¢ã¯ ã„ãã¤ ã§ãã¾ã™ã‹ã€‚',images:{prompt:'svg/cut_circle_4lines_grid.svg',choices:null},overrideType:'numeric',correctAnswer:'1',explanation:'ã¾ã‚“ä¸­ã®1ã“ã ã‘ãŒå››è§’å½¢ã€‚'}]},
    {templateId:'graph_sort_reason',generatorId:'pool',type:'multi',grade:2,unit:'ãƒ‡ãƒ¼ã‚¿',tags:['æ£’ã‚°ãƒ©ãƒ•','ä¸¦ã¹æ›¿ãˆ'],meta:{displayName:'ã‚°ãƒ©ãƒ•ã®ä¸¦ã¹æ›¿ãˆã®ç†ç”±',description:'ä¸¦ã¹æ›¿ãˆãŸã‚°ãƒ©ãƒ•ãŒã‚ã‹ã‚Šã‚„ã™ã„ç†ç”±ã‚’é¸ã¶'},pool:[{poolIndex:0,prompt:'2å¹´1çµ„ã§ ã™ããª ãã‚…ã†ã—ã‚‡ãã® ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ ã—ã‚‰ã¹ã¾ã—ãŸã€‚\nâ‘ åå‰ã®ã‚ã„ã†ãˆãŠé † â‘¡äººæ•°ã®å¤šã„é †\nâ‘¡ã®ã»ã†ãŒã‚ã‹ã‚Šã‚„ã™ã„ã‚Šã‚†ã†ã‚’ ã™ã¹ã¦ ãˆã‚‰ã³ã¾ã—ã‚‡ã†ã€‚',images:null,choices:[{label:'äººæ•°ãŒå¤šã„ã‚‚ã®ã‹ã‚‰ã˜ã‚…ã‚“ã«ãªã‚‰ã‚“ã§ã„ã‚‹ã®ã§ã€ãã‚‰ã¹ã‚„ã™ã„'},{label:'ã„ã¡ã°ã‚“äººæ°—ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã™ãã‚ã‹ã‚‹'},{label:'åå‰ã®ã˜ã‚…ã‚“ã«ãªã‚‰ã‚“ã§ã„ã‚‹ã®ã§ã€ã•ãŒã—ã‚„ã™ã„'},{label:'ã¼ã†ã®è‰²ãŒãã‚Œã„ã ã‹ã‚‰'}],correctAnswer:[true,true,false,false],explanation:'â‘¡ã¯äººæ•°ã®å¤šã„é †ãªã®ã§äººæ°—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã™ãã‚ã‹ã‚Šã¾ã™ã€‚'}]},
    {templateId:'equation_scene_sub_unknown',generatorId:'pool',type:'mcq',grade:2,unit:'ãŸã—ç®—ã¨ã²ãç®—',tags:['ç©´ã‚ãå¼','å ´é¢é¸æŠ'],meta:{displayName:'ç©´ã‚ãå¼ã®å ´é¢é¸æŠ',description:'72âˆ’â–¡ï¼45ã«åˆã†å ´é¢ã‚’é¸ã¶'},pool:[{poolIndex:0,prompt:'72âˆ’â–¡ï¼45 ã«åˆã†å ´é¢ã¯ã©ã‚Œã§ã™ã‹ã€‚',images:null,choices:[{label:'72äººã®ã†ã¡ 45äºº å¸°ã£ãŸ',semantic:{kind:'sub',subtype:'take_away',unknownPosition:'result'}},{label:'45äºº æ¥ãŸã‚‰ 72äººã« ãªã£ãŸ',semantic:{kind:'add',subtype:'increase',unknownPosition:'operand1'}},{label:'72äººã‹ã‚‰ ä½•äººã‹ å¸°ã£ãŸã‚‰ 45äººã« ãªã£ãŸ',semantic:{kind:'sub',subtype:'take_away',unknownPosition:'operand2'}},{label:'45äººã®ã†ã¡ 72äºº å¸°ã£ãŸ',semantic:null}],correctAnswer:2,explanation:'72âˆ’â–¡ï¼45 â†’ã€Œ72äººã‹ã‚‰ä½•äººã‹å¸°ã£ãŸã‚‰45äººã«ãªã£ãŸã€'}]},
    {templateId:'min_cuts_for_shape',generatorId:'pool',type:'numeric',grade:2,unit:'å›³å½¢',tags:['åˆ‡æ–­','æœ€å°å›æ•°'],meta:{displayName:'æœ€å°åˆ‡æ–­å›æ•°',description:'å›³å½¢ã‚’ä½œã‚‹ã®ã«æœ€ä½ä½•å›åˆ‡ã‚‹ã‹'},pool:[{poolIndex:0,prompt:'ã¾ã‚‹ã„ ã‹ã¿ã§ æ­£æ–¹å½¢ã‚’ 1ã¤ ä½œã‚ŠãŸã„ã§ã™ã€‚å°‘ãªãã¨ã‚‚ ä½•å› åˆ‡ã‚Šã¾ã™ã‹ã€‚',images:null,correctAnswer:'4',explanation:'æ­£æ–¹å½¢ã¯4è¾ºâ†’4å›ã€‚'},{poolIndex:1,prompt:'ä¸¸ã„ã‚±ãƒ¼ã‚­ã§ ä¸‰è§’å½¢ã‚’ 1ã¤ ä½œã‚‹ã«ã¯ å°‘ãªãã¨ã‚‚ ä½•å› åˆ‡ã‚Šã¾ã™ã‹ã€‚',images:null,correctAnswer:'3',explanation:'ä¸‰è§’å½¢ã¯3è¾ºâ†’3å›ã€‚'}]},
    {templateId:'array_counting_strategies',generatorId:'pool',type:'mcq',grade:2,unit:'ã‹ã‘ç®—',tags:['é…åˆ—','å·¥å¤«ã—ãŸæ•°ãˆæ–¹'],meta:{displayName:'é…åˆ—ã®å·¥å¤«ã—ãŸæ•°ãˆæ–¹',description:'ã„ã¡ã”é…åˆ—ã®å¼ã¨è€ƒãˆæ–¹ã‚’å¯¾å¿œã•ã›ã‚‹'},pool:[{poolIndex:0,prompt:'ã„ã¡ã”ãŒ5-5-3-3ã¨ãªã‚‰ã‚“ã§ã„ã¾ã™ã€‚\nã‚†ã„ã•ã‚“ã¯ 5Ã—2ï¼10ã€3Ã—2ï¼6ã€10ï¼‹6ï¼16 ã¨ã—ã¾ã—ãŸã€‚è€ƒãˆæ–¹ã¯ï¼Ÿ',images:{prompt:'svg/array_strawberry_5533.svg',choices:null},choices:[{label:'ãœã‚“ã¶5ã“Ã—4ã ã‚“ã¨è€ƒãˆã¦å¤šã„åˆ†ã‚’ã²ã'},{label:'ä¸Š2ã ã‚“ã¨ä¸‹2ã ã‚“ã«åˆ†ã‘ã¦ãŸã™'},{label:'ãœã‚“ã¶3ã“Ã—4ã ã‚“ã¨è€ƒãˆã¦ãŸã‚Šãªã„åˆ†ã‚’ãŸã™'}],correctAnswer:1,explanation:'ä¸Š2ã ã‚“+ä¸‹2ã ã‚“ã«åˆ†ã‘ã¦ãŸã™â†’ã‚¤'},{poolIndex:1,prompt:'ã„ã¡ã”ãŒ5-5-3-3ã¨ãªã‚‰ã‚“ã§ã„ã¾ã™ã€‚\nãã†ãŸã•ã‚“ã¯ 5Ã—4ï¼20ã€2Ã—2ï¼4ã€20âˆ’4ï¼16 ã¨ã—ã¾ã—ãŸã€‚è€ƒãˆæ–¹ã¯ï¼Ÿ',images:{prompt:'svg/array_strawberry_5533.svg',choices:null},choices:[{label:'ãœã‚“ã¶5ã“Ã—4ã ã‚“ã¨è€ƒãˆã¦å¤šã„åˆ†ã‚’ã²ã'},{label:'ä¸Š2ã ã‚“ã¨ä¸‹2ã ã‚“ã«åˆ†ã‘ã¦ãŸã™'},{label:'ãœã‚“ã¶3ã“Ã—4ã ã‚“ã¨è€ƒãˆã¦ãŸã‚Šãªã„åˆ†ã‚’ãŸã™'}],correctAnswer:0,explanation:'5Ã—4ã¨å¤šã‚ã«è€ƒãˆã¦ã€ãªã„ã¨ã“ã‚ã‚’ã²ãâ†’ã‚¢'},{poolIndex:2,prompt:'ã„ã¡ã”ãŒ5-5-3-3ã¨ãªã‚‰ã‚“ã§ã„ã¾ã™ã€‚\nã¯ã‚‹ã•ã‚“ã¯ 3Ã—4ï¼12ã€2Ã—2ï¼4ã€12ï¼‹4ï¼16 ã¨ã—ã¾ã—ãŸã€‚è€ƒãˆæ–¹ã¯ï¼Ÿ',images:{prompt:'svg/array_strawberry_5533.svg',choices:null},choices:[{label:'ãœã‚“ã¶5ã“Ã—4ã ã‚“ã¨è€ƒãˆã¦å¤šã„åˆ†ã‚’ã²ã'},{label:'ä¸Š2ã ã‚“ã¨ä¸‹2ã ã‚“ã«åˆ†ã‘ã¦ãŸã™'},{label:'ãœã‚“ã¶3ã“Ã—4ã ã‚“ã¨è€ƒãˆã¦ãŸã‚Šãªã„åˆ†ã‚’ãŸã™'}],correctAnswer:2,explanation:'3Ã—4ã¨å°‘ãªã‚ã«è€ƒãˆã¦ã€ãŸã‚Šãªã„åˆ†ã‚’ãŸã™â†’ã‚¦'}]},
    {templateId:'measure_from_reference',generatorId:'dynamic',type:'numeric',grade:2,unit:'é•·ã•',tags:['cm','m','åŸºæº–é‡'],meta:{displayName:'åŸºæº–é‡ã¨ã®å·®',description:'1mã®æ£’ã‚ˆã‚Šâ—‹cmé•·ã„/çŸ­ã„â†’ä½•cmï¼Ÿ'},vars:{referenceM:{type:'int',min:1,max:2},referenceCm:{type:'computed',expr:'vars.referenceM*100'},diff:{type:'int',min:5,max:50},direction:{type:'choice',options:['é•·ã„','çŸ­ã„']},answer:{type:'computed',expr:"vars.direction==='é•·ã„'?vars.referenceCm+vars.diff:vars.referenceCm-vars.diff"}},constraints:[{id:'positive_answer',expr:'vars.answer>0'}],generation:{method:'rejection',maxTries:50},promptTemplate:'{{subject}}ã¯ {{referenceM}}mã® ã¼ã†ã‚ˆã‚Š {{diff}}cm {{direction}} ã§ã™ã€‚ä½•cmã§ã™ã‹ã€‚',correctAnswerExpr:'String(vars.answer)',explanationTemplate:'{{referenceM}}mï¼{{referenceCm}}cmã€‚{{direction}}ã®ã§{{answer}}cmã€‚',subjectPool:['ã‚ãã‚‰ã•ã‚“ã®ã›ã®é«˜ã•','ã¿ã˜ã‹ã„ãƒªãƒœãƒ³','ã¤ããˆã®ã‚ˆã“ã®é•·ã•','ãªã‚ã¨ã³ã®ãªã‚']},
    {templateId:'triangle_tile_count',generatorId:'pool',type:'numeric',grade:2,unit:'å›³å½¢',tags:['ç›´è§’ä¸‰è§’å½¢','ã‚¿ã‚¤ãƒ«'],meta:{displayName:'ã‚¿ã‚¤ãƒ«ã§å›³å½¢ã‚’ã¤ãã‚‹',description:'ç›´è§’ä¸‰è§’å½¢ã‚¿ã‚¤ãƒ«ã§å›³å½¢ã‚’æ§‹æˆã™ã‚‹æšæ•°'},pool:[{poolIndex:0,subId:'10-1a',prompt:'ä¸‰è§’å½¢ã‚«ãƒ¼ãƒ‰ã§æ­£æ–¹å½¢ï¼ˆ2cmÃ—2cmï¼‰ã‚’ä½œã‚Šã¾ã™ã€‚ä½•ã¾ã„ï¼Ÿ',images:{prompt:'svg/tile_right_triangle.svg',choices:null},correctAnswer:'2',explanation:'ç›´è§’ä¸‰è§’å½¢2ã¾ã„ã§æ­£æ–¹å½¢1ã¤â†’2ã¾ã„ã€‚'},{poolIndex:1,subId:'10-1b',prompt:'ä¸‰è§’å½¢ã‚«ãƒ¼ãƒ‰ã§é•·æ–¹å½¢ï¼ˆ4cmÃ—2cmï¼‰ã‚’ä½œã‚Šã¾ã™ã€‚ä½•ã¾ã„ï¼Ÿ',images:{prompt:'svg/tile_right_triangle.svg',choices:null},correctAnswer:'4',explanation:'æ­£æ–¹å½¢2ã¤åˆ†â†’4ã¾ã„ã€‚'},{poolIndex:2,subId:'10-1c',prompt:'ä¸‰è§’å½¢ã‚«ãƒ¼ãƒ‰ã§å¤§ãã„æ­£æ–¹å½¢ï¼ˆ4cmÃ—4cmï¼‰ã‚’ä½œã‚Šã¾ã™ã€‚ä½•ã¾ã„ï¼Ÿ',images:{prompt:'svg/tile_right_triangle.svg',choices:null},correctAnswer:'8',explanation:'æ­£æ–¹å½¢4ã¤åˆ†â†’8ã¾ã„ã€‚'},{poolIndex:3,subId:'10-2',prompt:'ä¸‰è§’å½¢ã‚¿ã‚¤ãƒ«ã§é•·æ–¹å½¢ï¼ˆ4cmÃ—2cmï¼‰ã‚’ä½œã‚Šã¾ã™ã€‚ä½•ã¾ã„ï¼Ÿ',images:{prompt:'svg/tile_target_rect_4x2.svg',choices:null},overrideType:'mcq',choices:[{label:'4'},{label:'6'},{label:'8'},{label:'10'}],correctAnswer:0,explanation:'æ­£æ–¹å½¢2ã¤åˆ†â†’4ã¾ã„ã€‚'}]},
  ];
}

// â”€â”€ Handle OAuth redirect (if token is in URL hash) â”€â”€
(function checkRedirect() {
  if (window.location.hash.includes('access_token=')) {
    // We're in the popup - the parent will read our URL
    // Just show a message
    document.body.innerHTML = '<div style="text-align:center;padding:60px;font-size:18px">âœ… ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ï¼<br><small style="color:#888">ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯è‡ªå‹•ã§é–‰ã˜ã¾ã™...</small></div>';
  }
})();
</script>
</body>
</html>
